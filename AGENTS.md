# Repository Guidelines

## Project purpose
This project creates map-based animations using MapLibre. The general outline is
1. A prompt is submitted via the app
2. The prompt is converted to a program that defines how the camera moves around the map and animations in it
3. This program can be sent to the server to render it into a video which is then uploaded

Here are the primary goals
1. Allow the user's natural language command to intuitively and naturally convert to a high-quality map animation
based on the LLM's interpretation of the command and it using the built in phases/tools that anchor the animation
2. Make the preview in the app in web/ as close as possible to the final render so the user knows the appearance
3. To create a collection of useful plug-ins that allow different styles of animations, like map highlights,
building highlights, 3D flythroughs, etc.

## Project Structure & Modules
- `src/`: TypeScript backend (ESM). Entrypoint: `src/server.ts`; LLM logic in `src/llm.ts`; schemas in `src/program-schema.ts`; rendering helpers and assets (`renderer-page.html`, `webgl-launch.ts`).
- `web/`: Frontend preview assets (shared code in `web/src/shared`).
- `styles/`: Local MapLibre styles served at `/styles`.
- `scripts/`: Maintenance and utility scripts (e.g., IAM, WebGL checks).
- `dist/`: Compiled JS output (generated by `tsc`).

## Build, Test, and Development
- `npm install`: install deps.
- `npm run dev`: run server with live-reload via `tsx`.
- `npm run build`: compile TypeScript to `dist/` and copy renderer page.
- `npm start`: run compiled server (`dist/server.js`).
- `npm run test:webgl`: quick headless WebGL sanity check.
Example: `curl localhost:8080/healthz` â†’ `ok`.

## Coding Style & Conventions
- Language: TypeScript (strict mode, ESM). Use ESM imports with `.js` extensions in TS (matches emitted files), e.g., `import { nlToProgram } from "./llm.js"`.
- Indentation: 2 spaces; filenames: kebab-case (`program-schema.ts`).
- Prefer small, pure functions; validate inputs; surface errors with HTTP codes and JSON `{ error }`.

## Testing Guidelines
- No test runner yet; rely on typechecks (`npm run build`) and endpoint probes:
  - LLM parse: `POST /api/llm/parse { text }`.
  - Program resolve: `POST /api/resolve { text | program }`.
  - Geocode: `GET /api/geocode?q=...`.
- Add focused unit tests near modules if you introduce logic that benefits from isolation.

## Commit & Pull Requests
- Commits: imperative, concise scope first line (e.g., "server: cap FPS for fast mode"). Avoid noisy refactors in feature commits.
- PRs: include purpose, summary of changes, env vars touched, and testing steps (curl examples or screenshots). Link issues when applicable.

## Security & Configuration
- Required env: `OPENAI_API_KEY`. Optional: `OPENAI_BASE_URL`, `OPENAI_MODEL` (default `gpt-4.1`), `MAPTILER_KEY`, `CORS_ORIGIN`, `NOMINATIM_HOST`, `OVERPASS_URL`.
- Node 18+ recommended (ES2022 targets, ESM). Keep secrets in `.env`; see `.env.example` for shape.
use "gpt-4.1" as a default ai model to call for OpenAI
